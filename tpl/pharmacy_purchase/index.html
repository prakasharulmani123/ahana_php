<div class="bg-light lter b-b wrapper-md">
    <h1 class="m-n font-thin h3">Purchase List</h1>
</div>
<div class="wrapper-md" ng-controller="PurchaseController" ng-init="loadPurchaseItemList()">
    <div ng-include="'tpl/blocks/alert.html'">
        {% include 'tpl/blocks/alert.html' %}
    </div>
    <div class="panel panel-default">
        <div class="panel-body">
            <button class="btn btn-sm btn-grey" ng-click="loadPurchaseItemList()"> 
                &nbsp; &nbsp; <i class="fa fa-repeat"></i> &nbsp; &nbsp; 
            </button>
            <button check-access-button ng-click="$state.go('pharmacy.purchaseCreate')" class="btn btn-sm btn-info pull-right">
                <i class="fa fa-plus"></i> &nbsp; Add new Purchase
            </button>
        </div>
        <table st-table="displayedCollection"  st-safe-src="rowCollection" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th style="width: 5%">
                        <button class="btn btn-sm btn-default" type="button" ng-click="ctrl.expandAll(allExpanded = !allExpanded)">
                            <i ng-if="!allExpanded" class="fa fa-plus text"></i>
                            <i ng-if="allExpanded" class="fa fa-minus text"></i>
                        </button>
                    </th>
                    <th st-sort="purchase_code">Purchase #</th>
                    <th st-sort="invoice_date">Invoice Date</th>
                    <th st-sort="invoice_no">Invoice No.</th>
                    <th st-sort="supplier.supplier_name">Supplier Name</th>
                    <th st-sort="total_item_purchase_amount">Total Purchase Amount</th>
                    <th st-sort="total_item_vat_amount">Total Vat Amount</th>
                    <th st-sort="total_item_discount_amount">Total Product Disc. Amount</th>
                    <th st-sort="discount_percent">Disc. %</th>
                    <th st-sort="discount_amount">Disc Amount</th>
                    <th st-sort="roundoff_amount">Roundoff Amount</th>
                    <th st-sort="net_amount">net Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat-start="(key, row) in displayedCollection | orderBy: drug_name">
                    <td style="width: 5%">
                        <button ng-click="expanded = !expanded" expand class="btn btn-sm btn-default">
                            <i ng-if="!expanded" class="fa fa-plus text"></i>
                            <i ng-if="expanded" class="fa fa-minus text"></i>
                        </button>
                    </td>
                    <td>{{row.purchase_code}}</td>
                    <td>{{row.invoice_date}}</td>
                    <td>{{row.invoice_no}}</td>
                    <td>{{row.supplier.supplier_name}}</td>
                    <td>{{row.total_item_purchase_amount}}</td>
                    <td>{{row.total_item_vat_amount}}</td>
                    <td>{{row.total_item_discount_amount}}</td>
                    <td>{{row.discount_percent}}</td>
                    <td>{{row.discount_amount}}</td>
                    <td>{{row.roundoff_amount}}</td>
                    <td>{{row.net_amount}}</td>
                </tr>
                <tr ng-repeat-end ng-show="expanded">
                    <td></td>
                    <td colspan="11">
                        <table class="table table-condensed table-bordered">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Batch No</th>
                                    <th>Exp Date</th>
                                    <th>Qty</th>
                                    <th>Free</th>
                                    <th>F. Unit</th>
                                    <th>MRP</th>
                                    <th>P.Price</th>
                                    <th>Amt</th>
                                    <th>Dis %</th>
                                    <th>Dis Amt</th>
                                    <th>P.Vat</th>
                                    <th>Vat Amt</th>
                                    <th>P.Unit</th>
                                    <th>Total Amt</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="(gKey, purchaseitem) in row.items | orderBy: purchaseitem">
                                    <td>{{ purchaseitem.product.full_name}}</td>
                                    <td>{{ purchaseitem.batch.batch_no}}</td>
                                    <td>{{ purchaseitem.batch.expiry_date | moment:'MMM YYYY' || 'empty' }}</td>
                                    <td>{{ purchaseitem.quantity}}</td>
                                    <td>{{ purchaseitem.free_quantity}}</td>
                                    <td>{{ purchaseitem.free_quantity_unit}}</td>
                                    <td>{{ purchaseitem.mrp}}</td>
                                    <td>{{ purchaseitem.purchase_rate}}</td>
                                    <td>{{ purchaseitem.purchase_amount}}</td>
                                    <td>{{ purchaseitem.discount_percent}}</td>
                                    <td>{{ purchaseitem.discount_amount}}</td>
                                    <td>{{ purchaseitem.vat_percent}}</td>
                                    <td>{{ purchaseitem.vat_amount}}</td>
                                    <td>{{ purchaseitem.package_name}}</td>
                                    <td>{{ purchaseitem.total_amount}}</td>
                                </tr>
                            </tbody>
                        </table>                            
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
